import { promises as fs } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(scriptDir, "../../..");
const readmePath = path.join(repoRoot, "README.md");
const outputPath = path.join(repoRoot, "docs", "index.md");
const docsBase = "/zann/";

const raw = await fs.readFile(readmePath, "utf8");
const lines = raw.split(/\r?\n/);

let body = raw;
if (lines[0]?.startsWith("# ")) {
  const [, ...rest] = lines;
  body = rest.join("\n").replace(/^\s*\n/, "");
}

body = body.replaceAll("docs/screenshots/", `screenshots/`);
body = body.replaceAll("screenshots/", `${docsBase}screenshots/`);
body = body.replaceAll("docs/INSTALL.md", "/install/");

const frontmatter = [
  "---",
  "title: Zann Docs",
  "description: Overview and quick start for Zann.",
  "---",
  "",
  "<!-- Generated from README.md. Do not edit this file directly. -->",
  "",
].join("\n");

await fs.writeFile(outputPath, `${frontmatter}\n${body.trim()}\n`, "utf8");
