services:
  db:
    image: docker.io/library/postgres:16-alpine
    environment:
      POSTGRES_USER: zann
      POSTGRES_PASSWORD: zann
      POSTGRES_DB: zann
    ports:
      - "5432:5432"
    volumes:
      - zann_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zann -d zann"]
      interval: 5s
      timeout: 5s
      retries: 10

  migrate:
    build:
      context: .
      dockerfile: crates/zann-server/Dockerfile
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
      - ./data:/data:U
    environment:
      ZANN_DB_URL: postgres://zann:zann@db:5432/zann
      ZANN_DB_POOL_MAX: "5"
      ZANN_PASSWORD_PEPPER: dev-pepper
      ZANN_TOKEN_PEPPER: dev-pepper
      ZANN_CONFIG_PATH: /config/dev.yaml
      ZANN_SMK_FILE: /data/smk
    command: ["migrate"]
    restart: "no"

  server:
    build:
      context: .
      dockerfile: crates/zann-server/Dockerfile
    env_file:
      - .env
    volumes:
      - ./config:/config:ro
      - ./data:/data:U
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    environment:
      ZANN_DB_URL: postgres://zann:zann@db:5432/zann
      ZANN_DB_POOL_MAX: "10"
      ZANN_ADDR: 0.0.0.0:8080
      ZANN_PASSWORD_PEPPER: dev-pepper
      ZANN_TOKEN_PEPPER: dev-pepper
      ZANN_CONFIG_PATH: /config/dev.yaml
      ZANN_ALLOW_METRICS_DEBUG: "true"
      ZANN_SMK_FILE: /data/smk
      RUST_LOG: info

volumes:
  zann_pgdata:
