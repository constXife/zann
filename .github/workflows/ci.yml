name: ci

on:
  push:
  pull_request:

permissions:
  contents: read
  actions: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      rust: ${{ steps.filter.outputs.rust }}
      server: ${{ steps.filter.outputs.server }}
      docker: ${{ steps.filter.outputs.docker }}
      js: ${{ steps.filter.outputs.js }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - '**/*.md'
              - '.github/pull_request_template.md'
              - '.github/ISSUE_TEMPLATE/**'
            rust:
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'deny.toml'
              - 'rust-toolchain.toml'
            server:
              - 'crates/zann-server/**'
              - 'config/**'
              - 'compose.yaml'
            docker:
              - 'crates/zann-server/Dockerfile'
              - '.dockerignore'
              - 'compose.yaml'
            js:
              - 'apps/desktop/**'
              - 'bun.lockb'
            ci:
              - '.github/workflows/**'

  fmt:
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          components: rustfmt
      - name: Rust cache
        uses: ./.github/actions/rust-cache
      - name: Rust fmt
        run: cargo fmt --check

  test:
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    env:
      ZANN_CONFIG_PATH: config/ci.yaml
      ZANN_DB_URL: postgres://zann:zann@127.0.0.1:5432/zann
      TEST_DATABASE_URL: postgres://zann:zann@127.0.0.1:5432/zann
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: /home/runner/.cache/sccache
      SCCACHE_LOG: debug
      CARGO_INCREMENTAL: "0"
    services:
      postgres:
        image: docker.io/library/postgres:16
        env:
          POSTGRES_USER: zann
          POSTGRES_PASSWORD: zann
          POSTGRES_DB: zann
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U zann -d zann"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          components: clippy
      - name: Rust cache
        uses: ./.github/actions/rust-cache
        with:
          use-sccache: "true"
      - name: sccache version
        run: sccache --version
      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Migrate DB
        run: |
          cargo run -p zann-server -- migrate
      - name: Tests
        run: cargo test
      - name: Tests (zann-db Postgres)
        run: cargo test -p zann-db --features postgres
      - name: sccache stats
        if: always()
        run: sccache --show-stats

  audit:
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Security audit
        uses: rustsec/audit-check@v1.4.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  licenses:
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cargo deny
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check licenses

  licenses-js:
    needs: changes
    if: needs.changes.outputs.js == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install JS deps
        working-directory: apps/desktop
        run: bun install --frozen-lockfile
      - name: Check JS licenses
        working-directory: apps/desktop
        run: bunx license-checker --production --summary --excludePrivatePackages --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unicode-DFS-2016;Unlicense;CC0-1.0;0BSD;MPL-2.0"

  e2e-desktop:
    needs: changes
    if: needs.changes.outputs.js == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    env:
      TAURI_E2E_HEADLESS: "1"
      TAURI_E2E_ARTIFACTS_KEEP: "1"
      RUST_BACKTRACE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libayatana-appindicator3-dev \
            libxkbcommon-dev \
            libssl-dev \
            xvfb
          if ! sudo apt-get install -y webkit2gtk-driver; then
            sudo apt-get install -y webkit2gtk-4.1-driver
          fi
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0
      - name: Rust cache
        uses: ./.github/actions/rust-cache
      - name: Install tauri-driver
        run: cargo install tauri-driver
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install JS deps
        working-directory: apps/desktop
        run: bun install --frozen-lockfile
      - name: Run e2e tests
        working-directory: apps/desktop
        run: bun e2e

  docker:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (needs.changes.outputs.server == 'true' || needs.changes.outputs.docker == 'true' || needs.changes.outputs.ci == 'true')
    needs: changes
    env:
      DOCKERHUB_HOST: docker.io
      DOCKER_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/zann-server
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
        run: echo "$DOCKERHUB_PASS" | docker login "$DOCKERHUB_HOST" -u "$DOCKERHUB_USER" --password-stdin

      - name: Build
        run: docker build --build-arg GIT_COMMIT=${{ github.sha }} -f crates/zann-server/Dockerfile -t "$DOCKER_IMAGE:${{ github.sha }}" .

      - name: Tag
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            docker tag "$DOCKER_IMAGE:${{ github.sha }}" "$DOCKER_IMAGE:latest"
          fi
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            docker tag "$DOCKER_IMAGE:${{ github.sha }}" "$DOCKER_IMAGE:${GITHUB_REF_NAME}"
          fi

      - name: Push
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        run: |
          docker push "$DOCKER_IMAGE:${{ github.sha }}"
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            docker push "$DOCKER_IMAGE:latest"
          fi
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            docker push "$DOCKER_IMAGE:${GITHUB_REF_NAME}"
          fi
