name: Issue scope labeler

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  apply-scope-label:
    runs-on: ubuntu-latest
    steps:
      - name: Apply scope label from issue form
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";

            function extractField(name) {
              const regex = new RegExp(`###\\s+${name}\\s+([\\s\\S]*?)(?:\\n###|$)`, "i");
              const match = body.match(regex);
              if (!match) return null;
              const value = match[1].trim().split("\n")[0].trim();
              return value || null;
            }

            const area = extractField("Area");
            const areaLabels = {
              desktop: "s: desktop",
              cli: "s: cli",
              server: "s: server",
              core: "s: core",
              db: "s: db",
              keystore: "s: keystore",
              ci: "s: ci",
              repo: "s: repo",
            };

            const labelsToAdd = [];
            if (area && areaLabels[area]) {
              labelsToAdd.push(areaLabels[area]);
            }

            if (!labelsToAdd.length) {
              return;
            }

            const existing = issue.labels.map((label) => label.name);
            const missing = labelsToAdd.filter((label) => !existing.includes(label));
            if (!missing.length) {
              return;
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: missing,
            });
